<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout
      layout:decorate="~{common/layout/layout}">
<link rel="stylesheet" type="text/css" href="your-stylesheet.css">
<body>
<div layout:fragment="content">
  <input type="hidden" th:value="${dealId}" class="deal-id">
  <div class="deal-detail-card">
    <div class="deal-detail-card-body">
      <h2 th:text="${dealDetailResponseDto.firstMemberNickname}+'의 스왑 요청 !'"
          class="deal-detail-nickname"></h2>
      <h2 th:text="${dealDetailResponseDto.dealStatus.getName}" class="deal-detail-status"></h2>
    </div>
    <div class="deal-detail-content-container">
      <div class="deal-detail-request-list">
        <div class="deal-detail-list-container">
          <div th:text="${dealDetailResponseDto.firstMemberNickname}+'님의 스왑 물품'" class="deal-detail-post"></div>
          <input type="hidden" th:value="${dealDetailResponseDto.firstMemberBillId()}" class="first-member-bill-id">
          <div th:text="${dealDetailResponseDto.firstExtraFee() != null ? '추가금: ' + dealDetailResponseDto.firstExtraFee() : '추가금: 0'}" class="deal-detail-ExtraFee"></div>
          <div class="deal-allow-status">수락 상태:
          <div class="deal-detail-allow" th:text="${dealDetailResponseDto.firstAllow} ? '수락 완료' : '수락 대기'"></div>
          </div>
          <div class="deal-take-status">인수 상태:
            <div  class="deal-detail-take" th:text=" ${dealDetailResponseDto.firstTake} ? '인수 완료' : '인수 대기'"></div>
          </div>
          <div class="deal-swap-pay-status">스왑페이 사용여부:
            <div class="deal-detail-take" th:text=" ${dealDetailResponseDto.useSwapMoneyFirstMember()} ? '스왑페이 사용' : '스왑페이 미사용'"></div>
          </div>
            <img th:each="firstMemberPost : ${dealDetailResponseDto.firstDealPostList}" th:src="${firstMemberPost.imageUrl}" alt="Post Image" class="deal-detail-post-image">
          <div class="deal-detail-first-user-edit-button" th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().REQUESTED&&dealDetailResponseDto.firstMemberId()==memberId}"> <a
               th:href="@{/bills/{billId}/member/{memberId}(billId=${dealDetailResponseDto.firstMemberBillId()}, memberId=${dealDetailResponseDto.firstMemberId})}">
            수정하기
          </a>
          </div>
          <div class="deal-acceptance-buttons">
            <button class="deal-acceptance-button" th:if="${memberId==dealDetailResponseDto.firstMemberId()&&dealDetailResponseDto.firstExtraFee() != null&&!dealDetailResponseDto.firstAllow()}" th:text="${dealDetailResponseDto.useSwapMoneyFirstMember()} ? '스왑페이 사용 취소' : '스왑페이 사용'"  onclick="firstMemberSwapMoneyUse()"></button>
            <button th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().REQUESTED&&memberId==dealDetailResponseDto.firstMemberId()}" class="deal-acceptance-button" th:text="${dealDetailResponseDto.firstAllow} ? '수락취소하기' : '수락하기'"  onclick="dealfirstAllow()"></button>
            <button th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().DEALING&&memberId==dealDetailResponseDto.firstMemberId()}" class="deal-acceptance-button" onclick="dealTake()">거래 인수하기</button>
          </div>
        </div>
        <div class="deal-detail-list-container">
          <div th:text="${dealDetailResponseDto.secondMemberNickname()}+'님의 스왑 물품'" class="deal-detail-post"></div>
          <input type="hidden" th:value="${dealDetailResponseDto.secondMemberBillId()}" class="second-member-bill-id">
          <div th:text="${dealDetailResponseDto.secondExtraFee() != null ? '추가금: ' + dealDetailResponseDto.secondExtraFee() : '추가금: 0'}" class="deal-detail-ExtraFee"></div>
          <div class="deal-allow-status">수락 상태:
          <div class="deal-detail-allow" th:text= "${dealDetailResponseDto.secondAllow} ? '수락 완료' : '수락 대기'"></div>
          </div>
            <div class="deal-take-status">인수 상태:
          <div class="deal-detail-take" th:text=" ${dealDetailResponseDto.secondTake} ? '인수 완료' : '인수 대기'"></div>
            </div>
          <div class="deal-swap-pay-status">스왑페이 사용여부:
            <div class="deal-detail-take" th:text=" ${dealDetailResponseDto.useSwapMoneySecondMember()} ? '스왑페이 사용' : '스왑페이 미사용'"></div>
          </div>
              <img th:each="secondMemberPost : ${dealDetailResponseDto.secondDealPostList}" th:src="${secondMemberPost.imageUrl}" alt="Post Image" class="deal-detail-post-image">
          <div class="deal-detail-second-user-edit-button" th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().REQUESTED&&dealDetailResponseDto.secondMemberId()==memberId}"> <a
               th:href="@{/bills/{billId}/member/{memberId}(billId=${dealDetailResponseDto.secondMemberBillId()}, memberId=${dealDetailResponseDto.secondMemberId})}">
            수정하기</a>
          </div>
          <div class="deal-acceptance-buttons">
            <button class="deal-acceptance-button" th:if="${memberId==dealDetailResponseDto.secondMemberId()&&dealDetailResponseDto.secondExtraFee() != null&&!dealDetailResponseDto.secondAllow()}" th:text="${dealDetailResponseDto.useSwapMoneySecondMember()} ? '스왑페이 사용 취소' : '스왑페이 사용'"  onclick="secondMemberSwapMoneyUse()"></button>
            <button th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().REQUESTED&&memberId==dealDetailResponseDto.secondMemberId()}" class="deal-acceptance-button" th:text="${dealDetailResponseDto.secondAllow()} ? '수락취소하기' : '수락하기'"  onclick="dealSecondAllow()"></button>
            <button th:if="${dealDetailResponseDto.dealStatus()==dealDetailResponseDto.dealStatus().DEALING&&memberId==dealDetailResponseDto.secondMemberId()}" class="deal-acceptance-button" onclick="dealTake()">거래 인수하기</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script th:inline="javascript">
    const dealIdElement = document.querySelector('.deal-id');
    const dealId = +dealIdElement.value;
    const firstMemberBillIdElement = document.querySelector('.first-member-bill-id');
    const firstMemberBillId = +firstMemberBillIdElement.value;
    const secondMemberBillIdElement = document.querySelector('.second-member-bill-id');
    const secondMemberBillId = +secondMemberBillIdElement.value;

    var firstMemberSwapMoneyUrl = '/bills/' + firstMemberBillId +'/swap-pay'
    var secondMemberSwapMoneyUrl = '/bills/' + secondMemberBillId +'/swap-pay'
    var firstMemberUseSwapPayUrl = '/bills/' + firstMemberBillId + '/allow'+'/swap-pay'+'/true'
    var secondMemberUseSwapPayUrl = '/bills/' + secondMemberBillId + '/allow'+'/swap-pay'+'/true'
    var firstMemberNotUseSwapPayUrl = '/bills/' + firstMemberBillId + '/allow'+'/no-swap-pay'
    var secondMemberNotUseSwapPayUrl = '/bills/' + secondMemberBillId + '/allow'+'/no-swap-pay'
    var firstMemberCancelAllowUrl = '/bills/'+ firstMemberBillId + '/allow' + '/swap-pay' + '/false'
    var secondMemberCancelAllowUrl = '/bills/'+ secondMemberBillId + '/allow' + '/swap-pay' + '/false'
    var takeUrl = '/deals/' + dealId + '/take'
    var statusElements = document.querySelectorAll('.deal-detail-status');

    statusElements.forEach(function (element) {
      var statusName = element.textContent.trim();
      var statusColors = {
        '요청 중': '#FF0000',
        '거래 진행 중': '#00AADC',
        '거래 완료': '#000000'
      };

      if (statusColors.hasOwnProperty(statusName)) {
        var color = statusColors[statusName];
        element.style.color = color;
      }
    });

    function dealfirstAllow() {
      var useSwapMoneyFirstMember = /*[[${dealDetailResponseDto.useSwapMoneyFirstMember()}]]*/ false;
      var firstAllow = /*[[${dealDetailResponseDto.firstAllow}]]*/ false;

      if (useSwapMoneyFirstMember&&firstAllow) {
        $.ajax({
          url: firstMemberCancelAllowUrl,
          type: 'PATCH',
          success: function () {
            location.reload()
          },
          error: function (xhr, status, error) {
            alert("취소 할 수 없는 상태입니다.")
            console.error("Update failed", status,error);
          }
        });
      }
      if (useSwapMoneyFirstMember&&!firstAllow) {
        location.href = firstMemberUseSwapPayUrl
      } else if(!useSwapMoneyFirstMember) {
        $.ajax({
          url: firstMemberNotUseSwapPayUrl,
          type: 'PATCH',
          success: function () {
            location.reload();
          },
          error: function (xhr, status, error) {
            // 에러 처리
            alert("수락 할 수 없는 상태입니다.")
            console.error("Update failed:", status, error);
          }
        });
      }
    }

    function dealSecondAllow() {
      var useSwapMoneySecondMember = /*[[${dealDetailResponseDto.useSwapMoneySecondMember()}]]*/ false;
      var secondAllow = /*[[${dealDetailResponseDto.secondAllow}]]*/ false;
      if (useSwapMoneySecondMember && secondAllow) {

        $.ajax({
          url: secondMemberCancelAllowUrl,
          type: 'PATCH',
          success: function () {
            location.reload()
          },
          error: function (xhr, status, error) {
            alert("취소 할 수 없는 상태입니다.")
            console.error("Update failed", status, error);
          }
        });
      }

      if (useSwapMoneySecondMember&&!secondAllow) {
        location.href = secondMemberUseSwapPayUrl
      } else if(!useSwapMoneySecondMember&&!secondAllow) {
        $.ajax({
          url: secondMemberNotUseSwapPayUrl,
          type: 'PATCH',
          success: function () {
            location.reload();
          },
          error: function (xhr, status, error) {
            // 에러 처리
            alert("수락 할 수 없는 상태입니다.")
            console.error("Update failed:", status, error);
          }
        });
      }
    }

    function firstMemberSwapMoneyUse() {
      $.ajax({
        url: firstMemberSwapMoneyUrl,
        type: 'PATCH',
        success: function () {
          location.reload();
        },
        error: function (xhr, status, error) {
          // 에러 처리
          alert("스왑페이 사용여부를 변경 할 수 없는 상태입니다.")
          console.error("Update failed:", status, error);
        }
      })
    }

    function secondMemberSwapMoneyUse() {
      $.ajax({
        url: secondMemberSwapMoneyUrl,
        type: 'PATCH',
        success: function () {
          location.reload();
        },
        error: function (xhr, status, error) {
          // 에러 처리
          alert("스왑페이 사용여부를 변경 할 수 없는 상태입니다.")
          console.error("Update failed:", status, error);
        }
      })
    }

    function dealTake() {
      $.ajax({
        url: takeUrl,
        type: 'PATCH',
        success: function () {

          $('.deal-detail-take').text('인수 완료').css('color', '#3366CC');
          location.reload();
        },
        error: function (xhr, status, error) {
          // 에러 처리
          alert("인수 할 수 없는 상태입니다.")
          console.error("Update failed:", status, error);
        }
      })
    }
  </script>
</div>
</body>
</html>